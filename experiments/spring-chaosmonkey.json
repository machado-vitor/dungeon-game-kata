{
  "version": "1.0.0",
  "title": "Enable Chaos Monkey and apply latency assault",
  "description": "Uses chaostoolkit-spring to enable Chaos Monkey, configure latency assault, and verify it.",
  "tags": ["spring", "chaosmonkey", "latency"],
  "configuration": {
    "base_url": {
      "type": "env",
      "key": "APP_URL",
      "default": "http://localhost:9050/actuator"
    }
  },
  "steady-state-hypothesis": {
    "title": "Service is healthy",
    "probes": [
      {
        "name": "health-check",
        "type": "probe",
        "tolerance": { "type": "range", "range": [200, 299], "target": "status" },
        "provider": {
          "type": "http",
          "url": "${base_url}/health",
          "timeout": 5,
          "method": "GET"
        }
      }
    ]
  },
  "method": [
    {
      "name": "ensure-chaosmonkey-disabled",
      "type": "action",
      "provider": {
        "type": "python",
        "module": "chaosspring.actions",
        "func": "disable_chaosmonkey",
        "arguments": {
          "base_url": "${base_url}"
        }
      }
    },
    {
      "name": "enable-chaosmonkey",
      "type": "action",
      "provider": {
        "type": "python",
        "module": "chaosspring.actions",
        "func": "enable_chaosmonkey",
        "arguments": {
          "base_url": "${base_url}"
        }
      }
    },
    {
      "name": "configure-latency-assault",
      "type": "action",
      "provider": {
        "type": "python",
        "module": "chaosspring.actions",
        "func": "change_assaults_configuration",
        "arguments": {
          "base_url": "${base_url}",
          "assaults_configuration": {
            "level": 5,
            "latencyRangeStart": 500,
            "latencyRangeEnd": 1500,
            "latencyActive": true,
            "exceptionsActive": false,
            "killApplicationActive": false,
            "restartApplicationActive": false
          }
        }
      }
    },
    {
      "name": "verify-chaosmonkey-enabled",
      "type": "probe",
      "tolerance": true,
      "provider": {
        "type": "python",
        "module": "chaosspring.probes",
        "func": "chaosmonkey_enabled",
        "arguments": {
          "base_url": "${base_url}"
        }
      }
    }
  ],
  "rollbacks": [
    {
      "name": "disable-chaosmonkey",
      "type": "action",
      "provider": {
        "type": "python",
        "module": "chaosspring.actions",
        "func": "disable_chaosmonkey",
        "arguments": {
          "base_url": "${base_url}"
        }
      }
    },
    {
      "name": "reset-assaults-configuration",
      "type": "action",
      "provider": {
        "type": "python",
        "module": "chaosspring.actions",
        "func": "change_assaults_configuration",
        "arguments": {
          "base_url": "${base_url}",
          "assaults_configuration": {
            "level": 3,
            "latencyActive": false,
            "exceptionsActive": false,
            "killApplicationActive": false,
            "restartApplicationActive": false
          }
        }
      }
    }
  ]
}
