global
    log stdout format raw local0
    maxconn 2000
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries 3
    option  redispatch

frontend http-in
    bind *:80
    # Health check endpoint
    monitor-uri /haproxy-health
    default_backend apps

# Stats frontend
frontend stats-frontend
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats admin if TRUE

backend apps
    balance roundrobin
    option httpchk GET /hello
    http-check expect status 200
    
    # Backend servers with proper health checks
    server app1 app1:8080 check inter 3s fall 3 rise 2
    server app2 app2:8080 check inter 3s fall 3 rise 2
    server app3 app3:8080 check inter 3s fall 3 rise 2
    option http-server-close
    option forwardfor
    maxconn 300
